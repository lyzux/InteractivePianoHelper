<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Piano Physics Studio</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #fff;
            min-height: 100vh;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin: 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
            margin: 10px 0;
        }
        
        .controls-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            max-width: 1600px;
            margin: 0 auto;
        }
        
        .physics-category {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .physics-category h3 {
            margin: 0 0 15px 0;
            font-size: 1.3em;
            color: #fff;
            border-bottom: 2px solid rgba(255, 255, 255, 0.3);
            padding-bottom: 8px;
        }
        
        .parameter-group {
            margin-bottom: 15px;
        }
        
        .parameter-label {
            display: block;
            font-size: 0.9em;
            margin-bottom: 5px;
            color: #e0e0e0;
            font-weight: 500;
        }
        
        .parameter-control {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }
        
        .slider {
            flex: 1;
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            outline: none;
            appearance: none;
            cursor: pointer;
        }
        
        .slider::-webkit-slider-thumb {
            appearance: none;
            width: 18px;
            height: 18px;
            background: #fff;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            transition: transform 0.1s;
        }
        
        .slider::-webkit-slider-thumb:hover {
            transform: scale(1.1);
        }
        
        .slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            background: #fff;
            border-radius: 50%;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }
        
        .value-display {
            min-width: 50px;
            text-align: right;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            color: #ccc;
        }
        
        .test-controls {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 15px;
            padding: 20px;
            margin: 20px auto;
            max-width: 600px;
            text-align: center;
        }
        
        .test-controls h3 {
            margin: 0 0 20px 0;
            font-size: 1.4em;
        }
        
        .test-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        
        .test-btn {
            padding: 12px 20px;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 25px;
            color: #fff;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .test-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }
        
        .test-btn:active {
            transform: translateY(0);
        }
        
        .preset-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        
        .preset-btn {
            padding: 8px 16px;
            background: rgba(50, 150, 250, 0.6);
            border: 1px solid rgba(50, 150, 250, 0.8);
            border-radius: 20px;
            color: #fff;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.2s;
        }
        
        .preset-btn:hover {
            background: rgba(50, 150, 250, 0.8);
        }
        
        .navigation {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
        
        .nav-btn {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 25px;
            color: #fff;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.2s;
            backdrop-filter: blur(10px);
        }
        
        .nav-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }
        
        .description {
            font-size: 0.8em;
            color: #ccc;
            font-style: italic;
            margin-top: 2px;
        }
        
        .category-icon {
            display: inline-block;
            margin-right: 8px;
            font-size: 1.2em;
        }
        
        @media (max-width: 768px) {
            .controls-container {
                grid-template-columns: 1fr;
            }
            
            .test-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .preset-controls {
                flex-direction: column;
                align-items: center;
            }
        }
    </style>
</head>
<body>
    <div class="navigation">
        <a href="index.html" class="nav-btn">‚Üê Back to Piano</a>
    </div>
    
    <div class="header">
        <h1>üéπ Piano Physics Studio</h1>
        <p>Advanced Concert Piano Sound Generation Parameters</p>
        <p>Adjust physical modeling parameters to create your perfect piano sound</p>
    </div>
    
    <div class="test-controls">
        <h3>üéµ Test Your Sound</h3>
        <div class="test-buttons">
            <button class="test-btn" onclick="playTestNote('C3')">C3 Bass</button>
            <button class="test-btn" onclick="playTestNote('C4')">C4 Middle</button>
            <button class="test-btn" onclick="playTestNote('C5')">C5 Treble</button>
            <button class="test-btn" onclick="playTestChord()">C Major Chord</button>
            <button class="test-btn" onclick="playTestScale()">C Scale</button>
        </div>
        
        <div class="preset-controls">
            <button class="preset-btn" onclick="loadPreset('grand')">üéº Grand Piano</button>
            <button class="preset-btn" onclick="loadPreset('upright')">üè† Upright Piano</button>
            <button class="preset-btn" onclick="loadPreset('vintage')">üìª Vintage Piano</button>
            <button class="preset-btn" onclick="loadPreset('modern')">‚ú® Modern Piano</button>
            <button class="preset-btn" onclick="loadPreset('experimental')">üî¨ Experimental</button>
            <button class="preset-btn" onclick="resetToDefaults()">üîÑ Reset All</button>
            <button class="preset-btn" onclick="saveCurrentSettings()" style="background: rgba(50, 200, 50, 0.6); border-color: rgba(50, 200, 50, 0.8);">üíæ Save Settings</button>
            <button class="preset-btn" onclick="loadSavedSettings()">üìÇ Load Settings</button>
        </div>
    </div>
    
    <div class="controls-container" id="controlsContainer">
        <!-- Physics controls will be generated here -->
    </div>
    
    <script type="module">
        import { AudioEngine } from './js/audioEngine.js';
        
        let audioEngine = null;
        let isPlaying = false;
        
        // Initialize audio engine
        async function initAudio() {
            audioEngine = new AudioEngine();
            await audioEngine.init();
            console.log('Piano Physics Studio initialized');
        }
        
        // Parameter definitions with UI metadata
        const parameterDefinitions = {
            stringSource: {
                title: 'üéª String Source & Vibration',
                description: 'Physical properties of piano strings and their vibration characteristics',
                parameters: {
                    stringTension: { min: 0.5, max: 2.0, step: 0.01, default: 1.0, label: 'String Tension', desc: 'Affects pitch stability and harmonic content' },
                    stringMassPerUnit: { min: 0.5, max: 2.0, step: 0.01, default: 1.0, label: 'String Mass', desc: 'Heavier strings = darker tone' },
                    materialStiffness: { min: 0.5, max: 2.0, step: 0.01, default: 1.0, label: 'Material Stiffness', desc: 'Steel vs. wound strings' },
                    dispersionCoefficient: { min: 0.00005, max: 0.0005, step: 0.00001, default: 0.0001, label: 'Inharmonicity', desc: 'String stiffness causing sharp overtones' },
                    unisonStringsCount: { min: 1, max: 3, step: 1, default: 3, label: 'Max Unison Strings', desc: 'Multiple strings per note' },
                    unisonDetuning: { min: 0, max: 20, step: 0.1, default: 8.0, label: 'Unison Detuning (cents)', desc: 'Slight detuning creates shimmer' },
                    attackEnvelope: { min: 0.001, max: 0.05, step: 0.001, default: 0.008, label: 'Attack Time', desc: 'How quickly string starts vibrating' },
                    decayEnvelope: { min: 0.01, max: 0.5, step: 0.01, default: 0.08, label: 'Decay Time', desc: 'Initial energy loss rate' },
                    nonlinearCoupling: { min: 0, max: 1, step: 0.01, default: 0.1, label: 'Nonlinear Coupling', desc: 'String interaction effects' }
                }
            },
            
            hammer: {
                title: 'üî® Hammer Interaction',
                description: 'Felt hammer striking characteristics and mechanical properties',
                parameters: {
                    feltHardness: { min: 0, max: 1, step: 0.01, default: 0.5, label: 'Felt Hardness', desc: 'Soft felt = warm tone, Hard felt = bright tone' },
                    strikeVelocityResponse: { min: 0.5, max: 1.5, step: 0.01, default: 0.8, label: 'Velocity Response', desc: 'How much velocity affects tone' },
                    strikePosition: { min: 0.1, max: 0.3, step: 0.01, default: 0.14, label: 'Strike Position', desc: 'Distance from bridge (affects harmonics)' },
                    hammerMass: { min: 0.5, max: 2.0, step: 0.01, default: 1.0, label: 'Hammer Mass', desc: 'Heavier = more fundamental, less harmonics' },
                    reboundDamping: { min: 0, max: 1, step: 0.01, default: 0.3, label: 'Rebound Damping', desc: 'Hammer bounce after strike' },
                    contactDuration: { min: 0.0005, max: 0.005, step: 0.0001, default: 0.002, label: 'Contact Duration', desc: 'How long hammer touches string' },
                    feltCompression: { min: 0.3, max: 1.0, step: 0.01, default: 0.7, label: 'Felt Compression', desc: 'Velocity-dependent hardening' },
                    mechanicalNoise: { min: 0, max: 0.5, step: 0.01, default: 0.1, label: 'Mechanical Noise', desc: 'Hammer thump and felt sounds' }
                }
            },
            
            stringModes: {
                title: 'üåä String Vibration Modes',
                description: 'Complex vibration patterns and harmonic interactions',
                parameters: {
                    fundamentalMode: { min: 0.5, max: 2.0, step: 0.01, default: 1.0, label: 'Fundamental Strength', desc: 'Base frequency amplitude' },
                    unisonBeating: { min: 0, max: 2, step: 0.01, default: 0.5, label: 'Unison Beating', desc: 'Tremolo from multiple strings' },
                    energyTransfer: { min: 0, max: 1, step: 0.01, default: 0.2, label: 'Energy Transfer', desc: 'Harmonic coupling strength' },
                    longitudinalVibration: { min: 0, max: 0.2, step: 0.01, default: 0.05, label: 'Longitudinal Vibration', desc: 'Length-wise string motion' },
                    torsionalVibration: { min: 0, max: 0.1, step: 0.01, default: 0.03, label: 'Torsional Vibration', desc: 'String twisting motion' }
                }
            },
            
            soundboard: {
                title: 'üéº Soundboard & Bridge',
                description: 'Wooden soundboard resonance and bridge coupling',
                parameters: {
                    bridgeCoupling: { min: 0.3, max: 1.5, step: 0.01, default: 0.8, label: 'Bridge Coupling', desc: 'String-to-soundboard energy transfer' },
                    bridgePosition: { min: 0.8, max: 1.0, step: 0.01, default: 0.9, label: 'Bridge Position', desc: 'Affects harmonic transmission' },
                    materialDensity: { min: 0.5, max: 1.5, step: 0.01, default: 1.0, label: 'Wood Density', desc: 'Denser wood = different resonance' },
                    dampingFactor: { min: 0.1, max: 0.8, step: 0.01, default: 0.3, label: 'Damping Factor', desc: 'How quickly resonances decay' },
                    nonlinearAmplitude: { min: 0, max: 0.5, step: 0.01, default: 0.1, label: 'Nonlinear Effects', desc: 'Distortion at high volumes' },
                    radiationEfficiency: { min: 0.3, max: 1.0, step: 0.01, default: 0.7, label: 'Radiation Efficiency', desc: 'How well soundboard projects sound' },
                    phaseRelationships: { min: 0, max: 1, step: 0.01, default: 0.5, label: 'Phase Relationships', desc: 'Interference between resonance modes' }
                }
            },
            
            sympathetic: {
                title: 'üé∂ Sympathetic Resonance',
                description: 'Other strings resonating in sympathy',
                parameters: {
                    undampedResonance: { min: 0, max: 1.5, step: 0.01, default: 0.8, label: 'Undamped Resonance', desc: 'Free strings resonating' },
                    duplexScaling: { min: 0, max: 0.8, step: 0.01, default: 0.3, label: 'Duplex Scaling', desc: 'Extra string segments resonating' },
                    aliquotResonance: { min: 0, max: 0.5, step: 0.01, default: 0.2, label: 'Aliquot Resonance', desc: 'High string additional segments' },
                    stringCoupling: { min: 0, max: 1, step: 0.01, default: 0.4, label: 'String Coupling', desc: 'String-to-string vibration transfer' },
                    pedalResonanceFactor: { min: 1.0, max: 4.0, step: 0.1, default: 2.0, label: 'Pedal Resonance Factor', desc: 'Sustain pedal effect multiplier' },
                    halfPedalEffect: { min: 0, max: 1, step: 0.01, default: 0.5, label: 'Half Pedal Effect', desc: 'Partial damping characteristics' }
                }
            },
            
            damping: {
                title: 'üõë Damping System',
                description: 'Felt dampers controlling string vibration',
                parameters: {
                    damperHardness: { min: 0.2, max: 1.0, step: 0.01, default: 0.6, label: 'Damper Hardness', desc: 'Felt damper material properties' },
                    contactPosition: { min: 0.5, max: 1.0, step: 0.01, default: 0.8, label: 'Contact Position', desc: 'Where damper touches string' },
                    liftSpeed: { min: 0.05, max: 0.3, step: 0.01, default: 0.1, label: 'Lift Speed', desc: 'How quickly dampers lift off' },
                    partialEffectiveness: { min: 0.5, max: 1.0, step: 0.01, default: 0.9, label: 'Damping Effectiveness', desc: 'How completely dampers stop vibration' },
                    mechanicalNoise: { min: 0, max: 0.2, step: 0.01, default: 0.05, label: 'Mechanical Noise', desc: 'Damper movement sounds' }
                }
            },
            
            pedals: {
                title: 'ü¶∂ Pedal Effects',
                description: 'Sustain, soft, and sostenuto pedal mechanisms',
                parameters: {
                    sustainState: { min: 0, max: 1, step: 0.01, default: 0, label: 'Sustain Pedal', desc: 'Sustain pedal position (0=off, 1=full)' },
                    softPedalShift: { min: 0, max: 1, step: 0.01, default: 0.0, label: 'Soft Pedal (Una Corda)', desc: 'Hammer position shift amount' },
                    unaCordePosition: { min: 0, max: 1, step: 0.01, default: 0.0, label: 'Una Corda Position', desc: 'How much hammers shift sideways' },
                    resonanceBuildupTime: { min: 0.05, max: 0.5, step: 0.01, default: 0.2, label: 'Resonance Buildup', desc: 'How quickly pedal resonance develops' },
                    releaseNoise: { min: 0, max: 0.1, step: 0.01, default: 0.03, label: 'Release Noise', desc: 'Mechanical sounds when releasing pedals' }
                }
            },
            
            mechanical: {
                title: '‚öôÔ∏è Mechanical Artifacts',
                description: 'Key action, springs, and mechanical sounds',
                parameters: {
                    keyVelocityCurve: { min: 0.5, max: 1.5, step: 0.01, default: 0.8, label: 'Key Velocity Curve', desc: 'How key speed affects sound' },
                    keyReleaseSpeed: { min: 0.1, max: 1.0, step: 0.01, default: 0.5, label: 'Key Release Speed', desc: 'How quickly keys return' },
                    actionNoise: { min: 0, max: 0.3, step: 0.01, default: 0.1, label: 'Action Noise', desc: 'Key mechanism sounds' },
                    springResonance: { min: 0, max: 0.2, step: 0.01, default: 0.05, label: 'Spring Resonance', desc: 'Return spring vibrations' },
                    pedalCreaks: { min: 0, max: 0.1, step: 0.01, default: 0.02, label: 'Pedal Creaks', desc: 'Pedal mechanism sounds' },
                    bodyResonance: { min: 0, max: 0.3, step: 0.01, default: 0.1, label: 'Body Resonance', desc: 'Piano case wood resonance' },
                    tuningImperfections: { min: 0, max: 10, step: 0.1, default: 2.0, label: 'Tuning Imperfections (cents)', desc: 'Slight detuning variations' }
                }
            },
            
            acoustics: {
                title: 'üèõÔ∏è Acoustic Space',
                description: 'Room acoustics and sound projection',
                parameters: {
                    resonanceChamberVolume: { min: 0.5, max: 2.0, step: 0.01, default: 1.0, label: 'Chamber Volume', desc: 'Internal piano cavity size effect' },
                    materialResponse: { min: 0.3, max: 1.5, step: 0.01, default: 0.8, label: 'Material Response', desc: 'Piano case material characteristics' },
                    lidPosition: { min: 0, max: 1, step: 0.01, default: 1.0, label: 'Lid Position', desc: 'Piano lid open amount (0=closed, 1=full open)' },
                    radiationPattern: { min: 0.3, max: 1.0, step: 0.01, default: 0.7, label: 'Radiation Pattern', desc: 'How sound projects directionally' },
                    airAbsorption: { min: 0, max: 0.5, step: 0.01, default: 0.1, label: 'Air Absorption', desc: 'High frequency air absorption' },
                    stereoWidth: { min: 0.2, max: 1.0, step: 0.01, default: 0.6, label: 'Stereo Width', desc: 'Stereo image width of piano' },
                    roomReverb: { min: 0, max: 1, step: 0.01, default: 0.3, label: 'Room Reverb', desc: 'Simulated room reverberation' }
                }
            },
            
            expression: {
                title: 'üé≠ Performance Expression',
                description: 'Dynamic expression and playing characteristics',
                parameters: {
                    velocityBrightnessCurve: { min: 0.3, max: 1.5, step: 0.01, default: 0.7, label: 'Velocity‚ÜíBrightness', desc: 'How velocity affects tone brightness' },
                    velocityVolumeCurve: { min: 0.5, max: 1.5, step: 0.01, default: 0.8, label: 'Velocity‚ÜíVolume', desc: 'How velocity affects loudness' },
                    repetitionSpeed: { min: 0.5, max: 2.0, step: 0.01, default: 1.0, label: 'Repetition Speed', desc: 'Fast note repetition capability' },
                    aftertouch: { min: 0, max: 0.2, step: 0.01, default: 0.0, label: 'Aftertouch', desc: 'Continuous pressure effects' },
                    humanization: { min: 0, max: 0.5, step: 0.01, default: 0.1, label: 'Humanization', desc: 'Random variations for realism' },
                    tuningDrift: { min: 0, max: 2, step: 0.01, default: 0.5, label: 'Tuning Drift (cents)', desc: 'Gradual pitch variations over time' }
                }
            }
        };
        
        // Generate UI controls
        function generateControls() {
            const container = document.getElementById('controlsContainer');
            
            Object.entries(parameterDefinitions).forEach(([categoryKey, category]) => {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'physics-category';
                
                const title = document.createElement('h3');
                title.innerHTML = category.title;
                categoryDiv.appendChild(title);
                
                const description = document.createElement('div');
                description.className = 'description';
                description.textContent = category.description;
                categoryDiv.appendChild(description);
                
                Object.entries(category.parameters).forEach(([paramKey, param]) => {
                    const paramGroup = document.createElement('div');
                    paramGroup.className = 'parameter-group';
                    
                    const label = document.createElement('label');
                    label.className = 'parameter-label';
                    label.textContent = param.label;
                    paramGroup.appendChild(label);
                    
                    const controlDiv = document.createElement('div');
                    controlDiv.className = 'parameter-control';
                    
                    const slider = document.createElement('input');
                    slider.type = 'range';
                    slider.className = 'slider';
                    slider.min = param.min;
                    slider.max = param.max;
                    slider.step = param.step;
                    slider.value = param.default;
                    slider.id = `${categoryKey}_${paramKey}`;
                    
                    const valueDisplay = document.createElement('span');
                    valueDisplay.className = 'value-display';
                    valueDisplay.textContent = param.default.toFixed(3);
                    valueDisplay.id = `${categoryKey}_${paramKey}_value`;
                    
                    slider.addEventListener('input', (e) => {
                        const value = parseFloat(e.target.value);
                        valueDisplay.textContent = value.toFixed(3);
                        if (audioEngine) {
                            audioEngine.setPhysicsParameter(categoryKey, paramKey, value);
                            // Auto-save when parameters change
                            debounceAutoSave();
                        }
                    });
                    
                    controlDiv.appendChild(slider);
                    controlDiv.appendChild(valueDisplay);
                    paramGroup.appendChild(controlDiv);
                    
                    const desc = document.createElement('div');
                    desc.className = 'description';
                    desc.textContent = param.desc;
                    paramGroup.appendChild(desc);
                    
                    categoryDiv.appendChild(paramGroup);
                });
                
                container.appendChild(categoryDiv);
            });
        }
        
        // Test functions
        window.playTestNote = function(note) {
            if (audioEngine && !isPlaying) {
                isPlaying = true;
                audioEngine.playNote(note, 2.0, true, 0.8);
                setTimeout(() => { isPlaying = false; }, 3000);
            }
        };
        
        window.playTestChord = function() {
            if (audioEngine && !isPlaying) {
                isPlaying = true;
                const chord = ['C4', 'E4', 'G4'];
                chord.forEach((note, index) => {
                    setTimeout(() => audioEngine.playNote(note, 2.0, true, 0.7), index * 50);
                });
                setTimeout(() => { isPlaying = false; }, 3000);
            }
        };
        
        window.playTestScale = function() {
            if (audioEngine && !isPlaying) {
                isPlaying = true;
                const scale = ['C4', 'D4', 'E4', 'F4', 'G4', 'A4', 'B4', 'C5'];
                scale.forEach((note, index) => {
                    setTimeout(() => audioEngine.playNote(note, 0.8, false, 0.6), index * 200);
                });
                setTimeout(() => { isPlaying = false; }, 2000);
            }
        };
        
        // Preset functions
        window.loadPreset = function(presetName) {
            const presets = {
                grand: {
                    // Bright, resonant grand piano
                    stringSource: { stringTension: 1.2, materialStiffness: 1.1, unisonDetuning: 6.0 },
                    hammer: { feltHardness: 0.6, strikeVelocityResponse: 0.9 },
                    soundboard: { bridgeCoupling: 1.0, radiationEfficiency: 0.9 },
                    sympathetic: { undampedResonance: 1.0, pedalResonanceFactor: 2.5 },
                    acoustics: { lidPosition: 1.0, roomReverb: 0.2 }
                },
                upright: {
                    // Warmer, more intimate upright piano
                    stringSource: { stringTension: 0.9, materialStiffness: 0.8, unisonDetuning: 10.0 },
                    hammer: { feltHardness: 0.4, strikeVelocityResponse: 0.7 },
                    soundboard: { bridgeCoupling: 0.7, radiationEfficiency: 0.6 },
                    sympathetic: { undampedResonance: 0.6, pedalResonanceFactor: 1.5 },
                    acoustics: { lidPosition: 0.5, roomReverb: 0.4 }
                },
                vintage: {
                    // Aged, characterful vintage piano
                    stringSource: { stringTension: 0.8, materialStiffness: 0.7, unisonDetuning: 15.0 },
                    hammer: { feltHardness: 0.3, strikeVelocityResponse: 0.6 },
                    mechanical: { tuningImperfections: 8.0, actionNoise: 0.2 },
                    sympathetic: { undampedResonance: 0.8, duplexScaling: 0.5 },
                    acoustics: { materialResponse: 0.6, roomReverb: 0.5 }
                },
                modern: {
                    // Clean, precise modern piano
                    stringSource: { stringTension: 1.3, materialStiffness: 1.2, unisonDetuning: 4.0 },
                    hammer: { feltHardness: 0.7, strikeVelocityResponse: 1.0 },
                    mechanical: { tuningImperfections: 0.5, actionNoise: 0.05 },
                    soundboard: { bridgeCoupling: 1.1, radiationEfficiency: 1.0 },
                    acoustics: { lidPosition: 1.0, roomReverb: 0.1 }
                },
                experimental: {
                    // Unusual, experimental settings
                    stringSource: { stringTension: 1.5, materialStiffness: 1.5, unisonDetuning: 20.0 },
                    hammer: { feltHardness: 0.8, reboundDamping: 0.8 },
                    stringModes: { torsionalVibration: 0.1, longitudinalVibration: 0.15 },
                    soundboard: { nonlinearAmplitude: 0.3 },
                    mechanical: { bodyResonance: 0.3 }
                }
            };
            
            const preset = presets[presetName];
            if (preset && audioEngine) {
                Object.entries(preset).forEach(([category, params]) => {
                    Object.entries(params).forEach(([param, value]) => {
                        audioEngine.setPhysicsParameter(category, param, value);
                        
                        // Update UI
                        const slider = document.getElementById(`${category}_${param}`);
                        const valueDisplay = document.getElementById(`${category}_${param}_value`);
                        if (slider && valueDisplay) {
                            slider.value = value;
                            valueDisplay.textContent = value.toFixed(3);
                        }
                    });
                });
                
                console.log(`Loaded ${presetName} preset`);
            }
        };
        
        window.resetToDefaults = function() {
            Object.entries(parameterDefinitions).forEach(([categoryKey, category]) => {
                Object.entries(category.parameters).forEach(([paramKey, param]) => {
                    if (audioEngine) {
                        audioEngine.setPhysicsParameter(categoryKey, paramKey, param.default);
                    }
                    
                    const slider = document.getElementById(`${categoryKey}_${paramKey}`);
                    const valueDisplay = document.getElementById(`${categoryKey}_${paramKey}_value`);
                    if (slider && valueDisplay) {
                        slider.value = param.default;
                        valueDisplay.textContent = param.default.toFixed(3);
                    }
                });
            });
            
            console.log('Reset all parameters to defaults');
            audioEngine.savePhysicsParameters(); // Auto-save after reset
        };
        
        // Auto-save with debouncing
        let autoSaveTimeout;
        function debounceAutoSave() {
            clearTimeout(autoSaveTimeout);
            autoSaveTimeout = setTimeout(() => {
                if (audioEngine) {
                    audioEngine.savePhysicsParameters();
                }
            }, 1000); // Save 1 second after last change
        }
        
        // Manual save function
        window.saveCurrentSettings = function() {
            if (audioEngine) {
                const success = audioEngine.savePhysicsParameters();
                if (success) {
                    // Visual feedback
                    const saveBtn = event.target;
                    const originalText = saveBtn.textContent;
                    saveBtn.textContent = '‚úÖ Saved!';
                    saveBtn.style.background = 'rgba(50, 250, 50, 0.8)';
                    
                    setTimeout(() => {
                        saveBtn.textContent = originalText;
                        saveBtn.style.background = 'rgba(50, 200, 50, 0.6)';
                    }, 2000);
                }
            }
        };
        
        // Load saved settings
        window.loadSavedSettings = function() {
            if (audioEngine) {
                const success = audioEngine.loadPhysicsParameters();
                if (success) {
                    // Update all UI sliders to match loaded values
                    updateUIFromAudioEngine();
                    
                    // Visual feedback
                    const loadBtn = event.target;
                    const originalText = loadBtn.textContent;
                    loadBtn.textContent = '‚úÖ Loaded!';
                    loadBtn.style.background = 'rgba(50, 150, 250, 0.8)';
                    
                    setTimeout(() => {
                        loadBtn.textContent = originalText;
                        loadBtn.style.background = 'rgba(50, 150, 250, 0.6)';
                    }, 2000);
                } else {
                    alert('No saved settings found!');
                }
            }
        };
        
        // Update UI sliders to match current audio engine values
        function updateUIFromAudioEngine() {
            Object.entries(parameterDefinitions).forEach(([categoryKey, category]) => {
                Object.entries(category.parameters).forEach(([paramKey, param]) => {
                    const currentValue = audioEngine.getPhysicsParameter(categoryKey, paramKey);
                    if (currentValue !== null) {
                        const slider = document.getElementById(`${categoryKey}_${paramKey}`);
                        const valueDisplay = document.getElementById(`${categoryKey}_${paramKey}_value`);
                        if (slider && valueDisplay) {
                            slider.value = currentValue;
                            valueDisplay.textContent = currentValue.toFixed(3);
                        }
                    }
                });
            });
        }
        
        // Initialize everything
        document.addEventListener('DOMContentLoaded', async () => {
            generateControls();
            await initAudio();
            
            // Load saved settings if available
            console.log('üîß Loading saved physics parameters...');
            const loaded = audioEngine.loadPhysicsParameters();
            if (loaded) {
                updateUIFromAudioEngine();
                console.log('‚úÖ Saved settings loaded and UI updated');
            } else {
                console.log('‚ÑπÔ∏è No saved settings found, using defaults');
            }
            
            console.log('Piano Physics Studio ready!');
        });
    </script>
</body>
</html>