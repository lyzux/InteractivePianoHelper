<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Klavierbass-Rhythmen</title>
    <script src="https://cdn.jsdelivr.net/npm/abcjs@6.2.2/dist/abcjs-basic-min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        h1 {
            text-align: center;
            color: #4a5568;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .controls {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .pedal-control {
            display: flex;
            align-items: center;
            gap: 10px;
            background: #edf2f7;
            padding: 10px 15px;
            border-radius: 8px;
        }

        .pedal-control input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .pedal-control label {
            cursor: pointer;
            margin: 0;
        }

        label {
            font-weight: 600;
            color: #4a5568;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        select, input, button {
            padding: 10px 15px;
            border-radius: 8px;
            border: 2px solid #e2e8f0;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        select:focus, input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            padding: 12px 30px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        button.stop {
            background: linear-gradient(135deg, #f56565 0%, #ed8936 100%);
        }

        .pattern-info {
            background: #f7fafc;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            border-left: 4px solid #667eea;
        }

        .pattern-info h2 {
            color: #4a5568;
            margin-bottom: 10px;
        }

        .pattern-info p {
            color: #718096;
            line-height: 1.6;
        }

        .notation {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .notation h3 {
            text-align: center;
            color: #4a5568;
            margin-bottom: 15px;
        }

        .notation-display {
            font-family: 'Courier New', monospace;
            font-size: 1.2em;
            color: #2d3748;
            white-space: pre;
            line-height: 1.8;
            text-align: center;
        }

        .staff-notation {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            overflow-x: auto;
        }

        .staff-notation h3 {
            text-align: center;
            color: #4a5568;
            margin-bottom: 20px;
        }

        #staffNotation {
            background: white;
            min-height: 200px;
        }

        .piano-container {
            overflow-x: auto;
            margin: 30px 0;
            background: #2d3748;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .piano {
            position: relative;
            display: flex;
            min-width: max-content;
            height: 160px;
        }

        .octave-group {
            display: flex;
            position: relative;
            border-right: 1px solid #4a5568;
        }

        .octave-group:last-child {
            border-right: none;
        }

        .key {
            position: relative;
            cursor: pointer;
            transition: all 0.1s ease;
        }

        .white-key {
            width: 24px;
            height: 150px;
            background: linear-gradient(to bottom, #ffffff, #fafafa);
            border: 1px solid #cbd5e0;
            border-radius: 0 0 3px 3px;
            box-shadow: 0 2px 3px rgba(0, 0, 0, 0.1);
        }

        .white-key:hover {
            background: linear-gradient(to bottom, #f7fafc, #e2e8f0);
        }

        .white-key.active {
            background: linear-gradient(to bottom, #fbbf24, #f59e0b);
            transform: translateY(2px);
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .black-key {
            position: absolute;
            width: 16px;
            height: 95px;
            background: linear-gradient(to bottom, #1a202c, #000);
            border-radius: 0 0 3px 3px;
            z-index: 2;
            box-shadow: 0 2px 3px rgba(0, 0, 0, 0.5);
        }

        .black-key:hover {
            background: linear-gradient(to bottom, #2d3748, #1a202c);
        }

        .black-key.active {
            background: linear-gradient(to bottom, #f59e0b, #d97706);
            transform: translateY(2px);
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.3);
        }

        .key-label {
            position: absolute;
            bottom: 5px;
            width: 100%;
            text-align: center;
            font-size: 9px;
            color: #718096;
            pointer-events: none;
            font-weight: 500;
        }

        .black-key .key-label {
            color: #e2e8f0;
            bottom: 3px;
            font-size: 8px;
        }

        .octave-label {
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            color: #718096;
            font-weight: 600;
        }

        .tempo-display {
            background: #edf2f7;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            color: #4a5568;
            min-width: 120px;
            text-align: center;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .playing {
            animation: pulse 0.5s ease-in-out infinite;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéπ Klavierbass-Rhythmen √úbersicht</h1>
        
        <div class="controls">
            <div class="control-group">
                <label for="pattern">Rhythmus-Muster</label>
                <select id="pattern">
                    <option value="alberti">Alberti-Bass (Klassik)</option>
                    <option value="waltz">Walzer (3/4 Takt)</option>
                    <option value="march">Marsch</option>
                    <option value="boogie">Boogie-Woogie</option>
                    <option value="stride">Stride Piano (Jazz)</option>
                    <option value="bossa">Bossa Nova</option>
                    <option value="ragtime">Ragtime</option>
                    <option value="ballad">Ballade</option>
                    <option value="tango">Tango</option>
                    <option value="habanera">Habanera</option>
                </select>
            </div>
            
            <div class="control-group">
                <label for="key">Tonart</label>
                <select id="key">
                    <option value="C">C-Dur</option>
                    <option value="G">G-Dur</option>
                    <option value="F">F-Dur</option>
                    <option value="Am">A-Moll</option>
                    <option value="Dm">D-Moll</option>
                </select>
            </div>
            
            <div class="control-group">
                <label for="tempo">Tempo (BPM)</label>
                <input type="range" id="tempo" min="60" max="180" value="120">
                <div class="tempo-display" id="tempoDisplay">120 BPM</div>
            </div>
            
            <div class="control-group">
                <label>&nbsp;</label>
                <button id="playBtn">‚ñ∂ Abspielen</button>
            </div>
            
            <div class="control-group">
                <label>&nbsp;</label>
                <button id="stopBtn" class="stop">‚èπ Stoppen</button>
            </div>
            
            <div class="control-group">
                <label>&nbsp;</label>
                <div class="pedal-control">
                    <input type="checkbox" id="sustain" checked>
                    <label for="sustain">üéπ Sustain-Pedal</label>
                </div>
            </div>
        </div>
        
        <div class="pattern-info" id="patternInfo">
            <h2>Alberti-Bass</h2>
            <p>Ein klassisches Begleitmuster, benannt nach Domenico Alberti. Die T√∂ne eines Akkords werden in der Reihenfolge tief-hoch-mittel-hoch gespielt. Sehr h√§ufig in der Klassik, besonders bei Mozart und Haydn.</p>
        </div>
        
        <div class="notation">
            <h3>Notation:</h3>
            <div class="notation-display" id="notationDisplay">
Takt 1: C - G - E - G  |  Takt 2: C - G - E - G
        (1 - 5 - 3 - 5)      (1 - 5 - 3 - 5)
            </div>
        </div>
        
        <div class="staff-notation">
            <h3>Bassschl√ºssel-Notation:</h3>
            <div id="staffNotation"></div>
        </div>
        
        <div class="piano-container">
            <div class="piano" id="piano">
                <!-- Piano keys will be generated by JavaScript -->
            </div>
        </div>
    </div>

    <script>
        // Audio Context Setup
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        let audioContext = null;
        let isPlaying = false;
        let currentTimeout = null;
        let noteTimeouts = [];
        let masterGainNode = null;
        let compressor = null;

        // Initialize audio context and effects
        function initAudio() {
            if (!audioContext) {
                audioContext = new AudioContext();
                
                // Create master gain
                masterGainNode = audioContext.createGain();
                masterGainNode.gain.value = 0.5;
                
                // Create compressor for more realistic dynamics
                compressor = audioContext.createDynamicsCompressor();
                compressor.threshold.value = -24;
                compressor.knee.value = 30;
                compressor.ratio.value = 12;
                compressor.attack.value = 0.003;
                compressor.release.value = 0.25;
                
                // Connect audio chain
                masterGainNode.connect(compressor);
                compressor.connect(audioContext.destination);
            }
        }

        // Pattern Definitions
        const patterns = {
            alberti: {
                name: 'Alberti-Bass',
                description: 'Ein klassisches Begleitmuster, benannt nach Domenico Alberti. Die T√∂ne eines Akkords werden in der Reihenfolge tief-hoch-mittel-hoch gespielt. Sehr h√§ufig in der Klassik, besonders bei Mozart und Haydn.',
                notation: 'Takt 1: C - G - E - G  |  Takt 2: C - G - E - G\n        (1 - 5 - 3 - 5)      (1 - 5 - 3 - 5)',
                pattern: (key) => {
                    const patterns = {
                        'C': ['C3', 'G3', 'E3', 'G3'],
                        'G': ['G2', 'D3', 'B2', 'D3'],
                        'F': ['F3', 'C4', 'A3', 'C4'],
                        'Am': ['A2', 'E3', 'C3', 'E3'],
                        'Dm': ['D3', 'A3', 'F3', 'A3']
                    };
                    return patterns[key];
                },
                timing: [1, 1, 1, 1]
            },
            waltz: {
                name: 'Walzer',
                description: 'Der klassische 3/4-Takt mit Betonung auf der ersten Z√§hlzeit. Bass auf 1, Akkord auf 2 und 3. Typisch f√ºr Wiener Walzer und viele Volkslieder.',
                notation: 'Takt 1: C - (E,G) - (E,G)  |  3/4 Takt\n        (1 -   2   -   3)       Boom - Cha - Cha',
                pattern: (key) => {
                    const patterns = {
                        'C': ['C3', ['E3', 'G3'], ['E3', 'G3']],
                        'G': ['G2', ['B2', 'D3'], ['B2', 'D3']],
                        'F': ['F3', ['A3', 'C4'], ['A3', 'C4']],
                        'Am': ['A2', ['C3', 'E3'], ['C3', 'E3']],
                        'Dm': ['D3', ['F3', 'A3'], ['F3', 'A3']]
                    };
                    return patterns[key];
                },
                timing: [1.5, 1, 1]
            },
            march: {
                name: 'Marsch',
                description: 'Kraftvoller 4/4-Rhythmus mit alternierenden Basst√∂nen und Akkorden. Typisch f√ºr Milit√§rm√§rsche und festliche Musik.',
                notation: 'Takt 1: C - (E,G,C) - G - (E,G,C)  |  4/4 Takt\n        (1 -    2    - 3 -    4)        Bass-Akkord-Bass-Akkord',
                pattern: (key) => {
                    const patterns = {
                        'C': ['C3', ['E3', 'G3', 'C4'], 'G2', ['E3', 'G3', 'C4']],
                        'G': ['G2', ['B2', 'D3', 'G3'], 'D2', ['B2', 'D3', 'G3']],
                        'F': ['F3', ['A3', 'C4', 'F4'], 'C3', ['A3', 'C4', 'F4']],
                        'Am': ['A2', ['C3', 'E3', 'A3'], 'E2', ['C3', 'E3', 'A3']],
                        'Dm': ['D3', ['F3', 'A3', 'D4'], 'A2', ['F3', 'A3', 'D4']]
                    };
                    return patterns[key];
                },
                timing: [1, 1, 1, 1]
            },
            boogie: {
                name: 'Boogie-Woogie',
                description: 'Swingender Blues-Rhythmus mit walking bass. Die linke Hand spielt ein repetitives Muster w√§hrend die rechte Hand improvisiert.',
                notation: 'Walking Bass Pattern:\nC - E - G - A - Bb - A - G - E\n(Shuffle-Rhythmus mit Swing-Feel)',
                pattern: (key) => {
                    const patterns = {
                        'C': ['C3', 'E3', 'G3', 'A3', 'Bb3', 'A3', 'G3', 'E3'],
                        'G': ['G2', 'B2', 'D3', 'E3', 'F3', 'E3', 'D3', 'B2'],
                        'F': ['F3', 'A3', 'C4', 'D4', 'Eb4', 'D4', 'C4', 'A3'],
                        'Am': ['A2', 'C3', 'E3', 'F3', 'G3', 'F3', 'E3', 'C3'],
                        'Dm': ['D3', 'F3', 'A3', 'Bb3', 'C4', 'Bb3', 'A3', 'F3']
                    };
                    return patterns[key];
                },
                timing: [0.75, 0.75, 0.75, 0.75, 0.75, 0.75, 0.75, 0.75]
            },
            stride: {
                name: 'Stride Piano',
                description: 'Jazz-Stil mit gro√üen Spr√ºngen zwischen Bass und Akkord. Die linke Hand "schreitet" √ºber die Tastatur.',
                notation: 'Takt 1: C2 - (E3,G3,C4) - G2 - (E3,G3,C4)\n        Bass - Akkord - Bass - Akkord\n        (Gro√üe Spr√ºnge zwischen tiefen und hohen T√∂nen)',
                pattern: (key) => {
                    const patterns = {
                        'C': ['C2', ['E3', 'G3', 'C4'], 'G2', ['E3', 'G3', 'C4']],
                        'G': ['G1', ['B2', 'D3', 'G3'], 'D2', ['B2', 'D3', 'G3']],
                        'F': ['F2', ['A3', 'C4', 'F4'], 'C2', ['A3', 'C4', 'F4']],
                        'Am': ['A1', ['C3', 'E3', 'A3'], 'E2', ['C3', 'E3', 'A3']],
                        'Dm': ['D2', ['F3', 'A3', 'D4'], 'A2', ['F3', 'A3', 'D4']]
                    };
                    return patterns[key];
                },
                timing: [1, 1, 1, 1]
            },
            bossa: {
                name: 'Bossa Nova',
                description: 'Brasilianischer Rhythmus mit synkopiertem Pattern. Sanft und flie√üend, typisch f√ºr lateinamerikanische Musik.',
                notation: 'Synkopiertes Pattern:\nC3 - - G3 - C3 - G3 -\n(1 e + a 2 e + a)\nBetonung auf off-beats',
                pattern: (key) => {
                    const patterns = {
                        'C': ['C3', null, 'G3', null, 'C3', null, 'G3', null],
                        'G': ['G2', null, 'D3', null, 'G2', null, 'D3', null],
                        'F': ['F3', null, 'C4', null, 'F3', null, 'C4', null],
                        'Am': ['A2', null, 'E3', null, 'A2', null, 'E3', null],
                        'Dm': ['D3', null, 'A3', null, 'D3', null, 'A3', null]
                    };
                    return patterns[key].filter(n => n !== null);
                },
                timing: [1.5, 0.5, 1, 1]
            },
            ragtime: {
                name: 'Ragtime',
                description: 'Synkopierter amerikanischer Stil mit "ragged" Rhythmus. Popul√§r im fr√ºhen 20. Jahrhundert, bekannt durch Scott Joplin.',
                notation: 'Bass - Akkord - Bass - Akkord (synkopiert)\nC2 - (E3,G3) - G2 - (E3,G3)\nMit charakteristischen Synkopen',
                pattern: (key) => {
                    const patterns = {
                        'C': ['C2', ['E3', 'G3'], 'G2', ['E3', 'G3'], 'C2', ['E3', 'G3', 'C4']],
                        'G': ['G1', ['B2', 'D3'], 'D2', ['B2', 'D3'], 'G1', ['B2', 'D3', 'G3']],
                        'F': ['F2', ['A3', 'C4'], 'C2', ['A3', 'C4'], 'F2', ['A3', 'C4', 'F4']],
                        'Am': ['A1', ['C3', 'E3'], 'E2', ['C3', 'E3'], 'A1', ['C3', 'E3', 'A3']],
                        'Dm': ['D2', ['F3', 'A3'], 'A2', ['F3', 'A3'], 'D2', ['F3', 'A3', 'D4']]
                    };
                    return patterns[key];
                },
                timing: [1, 0.75, 1, 0.75, 1, 1.5]
            },
            ballad: {
                name: 'Ballade',
                description: 'Ruhiges, gef√ºhlvolles Begleitmuster. Gebrochene Akkorde in langsamem Tempo, ideal f√ºr romantische St√ºcke.',
                notation: 'Arpeggierter Akkord:\nC3 - E3 - G3 - C4 - G3 - E3\n(Sanft flie√üend, legato)',
                pattern: (key) => {
                    const patterns = {
                        'C': ['C3', 'E3', 'G3', 'C4', 'G3', 'E3'],
                        'G': ['G2', 'B2', 'D3', 'G3', 'D3', 'B2'],
                        'F': ['F3', 'A3', 'C4', 'F4', 'C4', 'A3'],
                        'Am': ['A2', 'C3', 'E3', 'A3', 'E3', 'C3'],
                        'Dm': ['D3', 'F3', 'A3', 'D4', 'A3', 'F3']
                    };
                    return patterns[key];
                },
                timing: [1, 1, 1, 1, 1, 1]
            },
            tango: {
                name: 'Tango',
                description: 'Dramatischer argentinischer Rhythmus mit markanten Akzenten und Pausen. Leidenschaftlich und rhythmisch pr√§gnant.',
                notation: 'Tango-Rhythmus:\nC3 - C3 - G2 - G2 - (Pause) - C3\n(Staccato mit dramatischen Pausen)',
                pattern: (key) => {
                    const patterns = {
                        'C': ['C3', 'C3', 'G2', 'G2', null, 'C3'],
                        'G': ['G2', 'G2', 'D2', 'D2', null, 'G2'],
                        'F': ['F3', 'F3', 'C3', 'C3', null, 'F3'],
                        'Am': ['A2', 'A2', 'E2', 'E2', null, 'A2'],
                        'Dm': ['D3', 'D3', 'A2', 'A2', null, 'D3']
                    };
                    return patterns[key].filter(n => n !== null);
                },
                timing: [0.5, 0.5, 1, 1, 1]
            },
            habanera: {
                name: 'Habanera',
                description: 'Kubanischer Rhythmus, bekannt aus Bizets Carmen. Charakteristisches punktiertes Muster mit treibendem Charakter.',
                notation: 'Habanera-Rhythmus:\nC3 (lang) - E3 (kurz) - G3 - G3\n(Punktierter Rhythmus: lang-kurz-kurz-kurz)',
                pattern: (key) => {
                    const patterns = {
                        'C': ['C3', 'E3', 'G3', 'G3'],
                        'G': ['G2', 'B2', 'D3', 'D3'],
                        'F': ['F3', 'A3', 'C4', 'C4'],
                        'Am': ['A2', 'C3', 'E3', 'E3'],
                        'Dm': ['D3', 'F3', 'A3', 'A3']
                    };
                    return patterns[key];
                },
                timing: [1.5, 0.5, 1, 1]
            }
        };

        // Note frequencies (complete 88-key piano range)
        const noteFrequencies = {
            'A0': 27.50, 'A#0': 29.14, 'Bb0': 29.14, 'B0': 30.87,
            'C1': 32.70, 'C#1': 34.65, 'Db1': 34.65, 'D1': 36.71, 'D#1': 38.89, 'Eb1': 38.89, 'E1': 41.20, 'F1': 43.65,
            'F#1': 46.25, 'Gb1': 46.25, 'G1': 49.00, 'G#1': 51.91, 'Ab1': 51.91, 'A1': 55.00, 'A#1': 58.27, 'Bb1': 58.27, 'B1': 61.74,
            'C2': 65.41, 'C#2': 69.30, 'Db2': 69.30, 'D2': 73.42, 'D#2': 77.78, 'Eb2': 77.78, 'E2': 82.41, 'F2': 87.31,
            'F#2': 92.50, 'Gb2': 92.50, 'G2': 98.00, 'G#2': 103.83, 'Ab2': 103.83, 'A2': 110.00, 'A#2': 116.54, 'Bb2': 116.54, 'B2': 123.47,
            'C3': 130.81, 'C#3': 138.59, 'Db3': 138.59, 'D3': 146.83, 'D#3': 155.56, 'Eb3': 155.56, 'E3': 164.81, 'F3': 174.61,
            'F#3': 185.00, 'Gb3': 185.00, 'G3': 196.00, 'G#3': 207.65, 'Ab3': 207.65, 'A3': 220.00, 'A#3': 233.08, 'Bb3': 233.08, 'B3': 246.94,
            'C4': 261.63, 'C#4': 277.18, 'Db4': 277.18, 'D4': 293.66, 'D#4': 311.13, 'Eb4': 311.13, 'E4': 329.63, 'F4': 349.23,
            'F#4': 369.99, 'Gb4': 369.99, 'G4': 392.00, 'G#4': 415.30, 'Ab4': 415.30, 'A4': 440.00, 'A#4': 466.16, 'Bb4': 466.16, 'B4': 493.88,
            'C5': 523.25, 'C#5': 554.37, 'Db5': 554.37, 'D5': 587.33, 'D#5': 622.25, 'Eb5': 622.25, 'E5': 659.25, 'F5': 698.46,
            'F#5': 739.99, 'Gb5': 739.99, 'G5': 783.99, 'G#5': 830.61, 'Ab5': 830.61, 'A5': 880.00, 'A#5': 932.33, 'Bb5': 932.33, 'B5': 987.77,
            'C6': 1046.50, 'C#6': 1108.73, 'Db6': 1108.73, 'D6': 1174.66, 'D#6': 1244.51, 'Eb6': 1244.51, 'E6': 1318.51, 'F6': 1396.91,
            'F#6': 1479.98, 'Gb6': 1479.98, 'G6': 1567.98, 'G#6': 1661.22, 'Ab6': 1661.22, 'A6': 1760.00, 'A#6': 1864.66, 'Bb6': 1864.66, 'B6': 1975.53,
            'C7': 2093.00, 'C#7': 2217.46, 'Db7': 2217.46, 'D7': 2349.32, 'D#7': 2489.02, 'Eb7': 2489.02, 'E7': 2637.02, 'F7': 2793.83,
            'F#7': 2959.96, 'Gb7': 2959.96, 'G7': 3135.96, 'G#7': 3322.44, 'Ab7': 3322.44, 'A7': 3520.00, 'A#7': 3729.31, 'Bb7': 3729.31, 'B7': 3951.07,
            'C8': 4186.01
        };

        // Create Piano (88 keys)
        function createPiano() {
            const piano = document.getElementById('piano');
            piano.innerHTML = '';
            
            // Define the complete 88-key layout
            const octaves = [
                // Octave 0 (partial - only A, A#, B)
                {
                    number: 0,
                    whiteKeys: ['A', 'B'],
                    blackKeys: {'A#': 16}
                },
                // Octaves 1-7 (complete)
                ...Array.from({length: 7}, (_, i) => ({
                    number: i + 1,
                    whiteKeys: ['C', 'D', 'E', 'F', 'G', 'A', 'B'],
                    blackKeys: {'C#': 18, 'D#': 42, 'F#': 90, 'G#': 114, 'A#': 138}
                })),
                // Octave 8 (partial - only C)
                {
                    number: 8,
                    whiteKeys: ['C'],
                    blackKeys: {}
                }
            ];
            
            octaves.forEach(octave => {
                const octaveGroup = document.createElement('div');
                octaveGroup.className = 'octave-group';
                
                // Add octave label for C keys
                if (octave.whiteKeys.includes('C')) {
                    const label = document.createElement('div');
                    label.className = 'octave-label';
                    label.textContent = `C${octave.number}`;
                    octaveGroup.appendChild(label);
                }
                
                // Create white keys
                octave.whiteKeys.forEach((note, index) => {
                    const key = document.createElement('div');
                    key.className = 'key white-key';
                    key.dataset.note = note + octave.number;
                    
                    // Only label C keys and middle C area
                    if (note === 'C' || (octave.number === 4 && note === 'A')) {
                        const label = document.createElement('div');
                        label.className = 'key-label';
                        label.textContent = note === 'C' ? `C${octave.number}` : 'A4';
                        key.appendChild(label);
                    }
                    
                    octaveGroup.appendChild(key);
                });
                
                // Create black keys
                Object.entries(octave.blackKeys).forEach(([note, position]) => {
                    const key = document.createElement('div');
                    key.className = 'key black-key';
                    key.dataset.note = note + octave.number;
                    key.style.left = position + 'px';
                    
                    // Label only specific black keys for reference
                    if (octave.number === 4 && note === 'F#') {
                        const label = document.createElement('div');
                        label.className = 'key-label';
                        label.textContent = 'F#4';
                        key.appendChild(label);
                    }
                    
                    octaveGroup.appendChild(key);
                });
                
                piano.appendChild(octaveGroup);
            });
            
            // Scroll to middle of piano (around C4)
            setTimeout(() => {
                const container = document.querySelector('.piano-container');
                if (container) {
                    // Scroll to approximately middle C area
                    container.scrollLeft = (piano.scrollWidth - container.clientWidth) / 2;
                }
            }, 100);
        }

        // Play note with realistic piano sound
        function playNote(note, duration = 0.5) {
            initAudio();
            
            if (Array.isArray(note)) {
                note.forEach(n => playNote(n, duration));
                return;
            }
            
            const frequency = noteFrequencies[note];
            if (!frequency) return;
            
            const useSustain = document.getElementById('sustain').checked;
            const actualDuration = useSustain ? duration * 2.5 : duration;
            
            // Create multiple oscillators for richer sound (fundamental + harmonics)
            const oscillators = [];
            const gains = [];
            
            // Fundamental frequency
            oscillators[0] = audioContext.createOscillator();
            gains[0] = audioContext.createGain();
            oscillators[0].frequency.value = frequency;
            oscillators[0].type = 'sine';
            
            // 2nd harmonic (octave)
            oscillators[1] = audioContext.createOscillator();
            gains[1] = audioContext.createGain();
            oscillators[1].frequency.value = frequency * 2;
            oscillators[1].type = 'sine';
            
            // 3rd harmonic
            oscillators[2] = audioContext.createOscillator();
            gains[2] = audioContext.createGain();
            oscillators[2].frequency.value = frequency * 3;
            oscillators[2].type = 'sine';
            
            // 4th harmonic
            oscillators[3] = audioContext.createOscillator();
            gains[3] = audioContext.createGain();
            oscillators[3].frequency.value = frequency * 4;
            oscillators[3].type = 'sine';
            
            // 5th harmonic
            oscillators[4] = audioContext.createOscillator();
            gains[4] = audioContext.createGain();
            oscillators[4].frequency.value = frequency * 5;
            oscillators[4].type = 'sine';
            
            // Set harmonic amplitudes (decreasing for higher harmonics)
            const harmonicAmplitudes = [0.6, 0.3, 0.15, 0.08, 0.04];
            
            // Calculate velocity based on note register (lower notes louder)
            const noteNumber = parseInt(note.slice(-1));
            const velocityMultiplier = 1 - (noteNumber * 0.08);
            
            // Create envelope for each oscillator
            const now = audioContext.currentTime;
            const attackTime = 0.01;
            const decayTime = 0.1;
            const sustainLevel = useSustain ? 0.4 : 0.2;
            const releaseTime = useSustain ? actualDuration : actualDuration * 0.8;
            
            oscillators.forEach((osc, i) => {
                // Connect oscillator through gain to master
                osc.connect(gains[i]);
                gains[i].connect(masterGainNode);
                
                // ADSR envelope
                gains[i].gain.setValueAtTime(0, now);
                gains[i].gain.linearRampToValueAtTime(
                    harmonicAmplitudes[i] * velocityMultiplier, 
                    now + attackTime
                );
                gains[i].gain.exponentialRampToValueAtTime(
                    harmonicAmplitudes[i] * sustainLevel * velocityMultiplier, 
                    now + attackTime + decayTime
                );
                gains[i].gain.exponentialRampToValueAtTime(
                    0.001, 
                    now + releaseTime
                );
                
                // Start and stop oscillator
                osc.start(now);
                osc.stop(now + releaseTime + 0.1);
            });
            
            // Add slight detuning for richness
            oscillators[1].detune.value = 2;
            oscillators[2].detune.value = -3;
            oscillators[3].detune.value = 5;
            oscillators[4].detune.value = -7;
            
            // Visual feedback
            highlightKey(note);
            setTimeout(() => unhighlightKey(note), actualDuration * 1000);
        }

        // Highlight key
        function highlightKey(note) {
            if (Array.isArray(note)) {
                note.forEach(n => highlightKey(n));
                return;
            }
            
            // Try exact match first
            let key = document.querySelector(`[data-note="${note}"]`);
            
            // If not found and note contains 'b' (flat), try with '#' (sharp) of previous note
            if (!key && note.includes('b')) {
                const noteLetter = note[0];
                const octave = note.slice(-1);
                const prevNote = String.fromCharCode(noteLetter.charCodeAt(0) - 1);
                const sharpNote = prevNote + '#' + octave;
                key = document.querySelector(`[data-note="${sharpNote}"]`);
            }
            
            if (key) {
                key.classList.add('active');
                // Scroll key into view if needed
                const container = document.querySelector('.piano-container');
                const keyRect = key.getBoundingClientRect();
                const containerRect = container.getBoundingClientRect();
                
                if (keyRect.left < containerRect.left || keyRect.right > containerRect.right) {
                    key.scrollIntoView({ behavior: 'smooth', inline: 'center' });
                }
            }
        }

        // Unhighlight key
        function unhighlightKey(note) {
            if (Array.isArray(note)) {
                note.forEach(n => unhighlightKey(n));
                return;
            }
            
            // Try exact match first
            let key = document.querySelector(`[data-note="${note}"]`);
            
            // If not found and note contains 'b' (flat), try with '#' (sharp) of previous note
            if (!key && note.includes('b')) {
                const noteLetter = note[0];
                const octave = note.slice(-1);
                const prevNote = String.fromCharCode(noteLetter.charCodeAt(0) - 1);
                const sharpNote = prevNote + '#' + octave;
                key = document.querySelector(`[data-note="${sharpNote}"]`);
            }
            
            if (key) {
                key.classList.remove('active');
            }
        }

        // Play pattern
        function playPattern() {
            if (isPlaying) return;
            
            isPlaying = true;
            document.getElementById('playBtn').classList.add('playing');
            
            const patternType = document.getElementById('pattern').value;
            const key = document.getElementById('key').value;
            const tempo = parseInt(document.getElementById('tempo').value);
            
            const pattern = patterns[patternType];
            const notes = pattern.pattern(key);
            const timing = pattern.timing;
            
            let noteIndex = 0;
            const beatDuration = 60000 / tempo;
            
            function playNextNote() {
                if (!isPlaying || noteIndex >= notes.length) {
                    if (isPlaying && noteIndex >= notes.length) {
                        // Loop the pattern
                        noteIndex = 0;
                        playNextNote();
                    }
                    return;
                }
                
                const note = notes[noteIndex];
                const duration = timing[noteIndex % timing.length] * (beatDuration / 1000);
                
                if (note) {
                    playNote(note, duration);
                }
                
                noteIndex++;
                currentTimeout = setTimeout(playNextNote, duration * 1000);
            }
            
            playNextNote();
        }

        // Stop playing
        function stopPlaying() {
            isPlaying = false;
            if (currentTimeout) {
                clearTimeout(currentTimeout);
                currentTimeout = null;
            }
            noteTimeouts.forEach(timeout => clearTimeout(timeout));
            noteTimeouts = [];
            
            document.getElementById('playBtn').classList.remove('playing');
            document.querySelectorAll('.key').forEach(key => {
                key.classList.remove('active');
            });
        }

        // Convert note to ABC notation format
        function convertToABCNote(note) {
            if (!note) return 'z'; // Rest
            
            if (Array.isArray(note)) {
                // Chord notation in ABC: [CEG]
                return '[' + note.map(convertToABCNote).join('') + ']';
            }
            
            let noteName = note.charAt(0);
            let octave = parseInt(note.slice(-1));
            let accidental = note.slice(1, -1);
            
            // Handle accidentals
            if (accidental === '#') {
                noteName = '^' + noteName;
            } else if (accidental === 'b') {
                noteName = '_' + noteName;
            }
            
            // ABC octave notation for bass clef (corrected for actual bass clef display)
            // In ABC with bass clef: C, displays as C2, C displays as C3, c displays as C4, etc.
            // Our notes: C3 should display as C3 in bass clef, so we need C in ABC notation
            // C2 should display as C2 in bass clef, so we need C, in ABC notation
            if (octave === 1) {
                noteName = noteName.toUpperCase() + ',,,';
            } else if (octave === 2) {
                noteName = noteName.toUpperCase() + ',,';
            } else if (octave === 3) {
                noteName = noteName.toUpperCase() + ',';
            } else if (octave === 4) {
                noteName = noteName.toUpperCase();
            } else if (octave === 5) {
                noteName = noteName.toLowerCase();
            } else if (octave >= 6) {
                noteName = noteName.toLowerCase();
                for (let i = 6; i <= octave; i++) {
                    noteName += "'";
                }
            }
            
            return noteName;
        }

        // Generate ABC notation string
        function generateABCNotation() {
            const patternType = document.getElementById('pattern').value;
            const key = document.getElementById('key').value;
            const pattern = patterns[patternType];
            const notes = pattern.pattern(key);
            const timing = pattern.timing;
            
            // ABC header
            let abc = 'X:1\n';
            abc += `T:${pattern.name}\n`;
            abc += `K:${key} clef=bass\n`;
            
            // Set time signature based on pattern
            if (patternType === 'waltz') {
                abc += 'M:3/4\n';
            } else {
                abc += 'M:4/4\n';
            }
            abc += 'L:1/4\n';
            
            // Convert notes to ABC notation
            let abcNotes = [];
            notes.forEach((note, index) => {
                let abcNote = convertToABCNote(note);
                
                // Add rhythm notation based on timing
                const duration = timing[index % timing.length];
                if (duration === 0.5) {
                    abcNote += '/2';
                } else if (duration === 0.75) {
                    abcNote += '3/4';
                } else if (duration === 1.5) {
                    abcNote += '3/2';
                } else if (duration === 2) {
                    abcNote += '2';
                }
                
                abcNotes.push(abcNote);
            });
            
            // Group notes into measures
            abc += abcNotes.join(' ') + ' |\n';
            
            return abc;
        }

        // Draw staff notation using ABCjs
        function drawStaffNotation() {
            const abcNotation = generateABCNotation();
            const staffDiv = document.getElementById('staffNotation');
            
            // Clear previous notation
            staffDiv.innerHTML = '';
            
            // Render with ABCjs
            ABCJS.renderAbc('staffNotation', abcNotation, {
                responsive: 'resize',
                staffwidth: 600,
                scale: 1.2,
                paddingtop: 10,
                paddingbottom: 10,
                paddingleft: 20,
                paddingright: 20
            });
        }

        // Update pattern info
        function updatePatternInfo() {
            const patternType = document.getElementById('pattern').value;
            const pattern = patterns[patternType];
            
            document.getElementById('patternInfo').innerHTML = `
                <h2>${pattern.name}</h2>
                <p>${pattern.description}</p>
            `;
            
            document.getElementById('notationDisplay').textContent = pattern.notation;
            
            // Draw staff notation
            drawStaffNotation();
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            createPiano();
            
            // Event listeners
            document.getElementById('playBtn').addEventListener('click', () => {
                stopPlaying();
                setTimeout(playPattern, 100);
            });
            
            document.getElementById('stopBtn').addEventListener('click', stopPlaying);
            
            document.getElementById('pattern').addEventListener('change', () => {
                stopPlaying();
                updatePatternInfo();
            });
            
            document.getElementById('key').addEventListener('change', () => {
                stopPlaying();
                drawStaffNotation();
            });
            
            document.getElementById('tempo').addEventListener('input', (e) => {
                document.getElementById('tempoDisplay').textContent = e.target.value + ' BPM';
            });
            
            // Piano key click events
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('key')) {
                    const note = e.target.dataset.note;
                    if (note) {
                        playNote(note, 0.5);
                    }
                }
            });
            
            // Initialize pattern info
            updatePatternInfo();
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            stopPlaying();
            if (audioContext) {
                audioContext.close();
            }
        });
    </script>
</body>
</html>